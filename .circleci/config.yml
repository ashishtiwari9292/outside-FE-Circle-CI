version: 2.1

jobs:
  build:
    machine:
      image: ubuntu-2004:202010-01
    steps:
      - checkout
      - run:
          name: Installing AWS CLI
          command: |
            sudo apt-get update
            sudo apt-get install -y awscli
      - run: cd ./app && npm install --legacy-peer-deps && npm run build:production
      - persist_to_workspace:
          root: .
          paths:
            - .
# executors:
#   angular_executor:
#     docker:
#       - image: circleci/node:12.14.0-browsers

# jobs:
#   build:
#     executor: angular_executor
#     steps:
#       - checkout
#       - restore_cache:
#           keys:
#             - v1-dependencies-{{ checksum "package-lock.json" }}

#       - run:
#           name: Install Dependencies
#           command: npm install --legacy-peer-deps

#       - save_cache:
#           key: v1-dependencies-{{ checksum "package-lock.json" }}
#           paths:
#             - node_modules

#       - run:
#           name: Build
#           command: npm run build:production

  deploy:
    machine:
      image: ubuntu-2004:2023.04.2
    steps:
      - attach_workspace:
          at: .
      - checkout
      - run:
          name: Deploy to S3
          command: |
            # sudo apt-get update
            # sudo apt-get install -y awscli
            sudo aws configure set aws_access_key_id "AKIASHRYCLQM5SBLHGGB"
            sudo aws configure set aws_secret_access_key "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"
            sudo aws configure set default.region "us-east-1"
            sudo aws s3 sync /dist/outside-fe s3://outside-fe-circle-ci

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build

#   base-directory: 'dist/outside-fe'
